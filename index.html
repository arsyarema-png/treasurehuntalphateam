<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt Alpha Team - 10 Misi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
            /* Mencegah seleksi teks agar lebih sulit disalin */
            user-select: none; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .ai-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }
        .animate-pulse-fast { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }
        /* Mengizinkan seleksi pada input field agar tetap bisa mengetik */
        input {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }
    </style>
    <!-- Skrip Keamanan Sederhana -->
    <script>
        // Mencegah Klik Kanan
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Mencegah beberapa pintasan keyboard untuk membuka Developer Tools
        document.onkeydown = function(e) {
            // F12
            if(e.keyCode == 123) { return false; }
            // Ctrl+Shift+I
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
            // Ctrl+Shift+C
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
            // Ctrl+Shift+J
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
            // Ctrl+U (View Source)
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-treasure-hunt-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null, unsubscribe = null;
        let playerName = '';
        let currentGameState = null;
        const TOTAL_QUESTS = 10; // Batas maksimal quest diubah menjadi 10

        const fallbackPool = [
             { type: 'text', clue: 'Aku punya kaki tapi tak bisa berjalan. Aku punya punggung tapi tak punya tulang.', correctAnswer: 'kursi', hint: 'Tempat kamu duduk.', solvedMessage: 'Bagus! Tempat istirahat ditemukan.' },
             { type: 'photo', clue: 'Temukan sesuatu yang berwarna biru langit.', correctAnswer: 'photo', hint: 'Lihat ke atas atau cari benda di sekitar.', solvedMessage: 'Warna yang indah!' }
        ];

        const mainContainer = document.getElementById('main-container');
        const messageBox = document.getElementById('message-box');

        // --- AI Utils ---
        async function callGemini(prompt, imageData = null, useJson = false) {
            try {
                const parts = [{ text: prompt }];
                if (imageData) parts.push({ inlineData: { mimeType: imageData.mimeType, data: imageData.data } });
                const payload = { contents: [{ parts: parts }] };
                
                // Note: In a real deployment, ensure the API key is correctly set in the URL below.
                // If it fails (e.g. 400 Bad Request due to missing key), we catch it and return null.
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                     console.warn("AI API returned non-OK status, using fallback.");
                     return null;
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text.trim();
            } catch (error) { console.error("Gemini API Error:", error); return null; }
        }

        async function generateQuestAI(level) {
            const prompt = `Buatkan 1 tantangan treasure hunt seru dalam Bahasa Indonesia untuk level ${level} dari ${TOTAL_QUESTS}. 
            Output HARUS JSON valid dengan format persis ini:
            {
              "type": "text" atau "photo",
              "clue": "teka-teki atau perintah mencari objek...",
              "correctAnswer": "jawaban singkat (hanya jika type=text, kosongkan jika photo)",
              "hint": "petunjuk tambahan jika pemain buntu",
              "solvedMessage": "pesan pujian singkat saat berhasil"
            }
            Pastikan clue tidak terlalu abstrak, bisa berupa benda sehari-hari di sekitar rumah/kantor/sekolah.`;
            try {
                const jsonStr = await callGemini(prompt, null, true);
                if (!jsonStr) throw new Error("AI returned empty response for quest");
                const cleanedJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(cleanedJson);
            } catch (e) {
                console.warn("Gagal generate quest AI, gunakan fallback", e);
                return fallbackPool[Math.floor(Math.random() * fallbackPool.length)];
            }
        }

        async function validateWithAI(challenge, userAnswer, imageData = null) {
            let prompt = imageData 
                ? `Bertindak sebagai juri Treasure Hunt. Petunjuk: "${challenge.clue}". Apakah foto ini relevan dengan petunjuk? Jawab HANYA 'YA' atau 'TIDAK'.`
                : `Juri Treasure Hunt. Teka-teki: "${challenge.clue}". Jawaban Kunci: "${challenge.correctAnswer}". Jawaban Pemain: "${userAnswer}". Apakah jawaban pemain secara konsep BENAR (abaikan typo kecil)? Jawab HANYA 'YA' atau 'TIDAK'.`;
            const res = await callGemini(prompt, imageData);
            if (res === null && imageData) return true; // Fallback: accept photo if AI down
            return res ? res.toUpperCase().includes('YA') : false;
        }

        // --- Core Logic ---
        async function initializeFirebase() {
            if (!firebaseConfig) return renderError("Config Missing");
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
            onAuthStateChanged(auth, (user) => {
                if (user) { userId = user.uid; checkPlayerStatus(); }
                else { renderLoading("Menghubungkan ke markas..."); }
            });
            initialAuthToken ? await signInWithCustomToken(auth, initialAuthToken) : await signInAnonymously(auth);
        }

        async function checkPlayerStatus() {
            // Menggunakan collection baru _10q untuk 10 misi
            const docRef = doc(db, `/artifacts/${appId}/users/${userId}/treasure_hunt_10q`, 'game_state');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().playerName) {
                const data = docSnap.data();
                playerName = data.playerName;
                updateHeader();
                startRealtimeListener(docRef);
            } else { renderNameInput(); }
        }

        function startRealtimeListener(docRef) {
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentGameState = docSnap.data();
                    renderGameState();
                }
            });
        }

        function renderGameState() {
            const solved = currentGameState.solvedCount || 0;
            if (solved >= TOTAL_QUESTS) {
                renderVictory();
            } else if (!currentGameState.currentQuest) {
                generateAndSaveNextQuest(solved + 1);
                renderLoading(`ü§ñ AI sedang merancang Misi #${solved + 1}...`);
            } else {
                renderActiveQuest(currentGameState.currentQuest, solved);
            }
        }

        async function generateAndSaveNextQuest(nextLevel) {
            const newQuest = await generateQuestAI(nextLevel);
            // Menggunakan collection baru _10q
            await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/treasure_hunt_10q`, 'game_state'), {
                currentQuest: newQuest
            });
        }

        // --- Rendering UI ---
        function updateHeader() {
            // Bisa digunakan untuk update elemen header global jika ada
        }

        function renderNameInput() {
            mainContainer.innerHTML = `
                <div class="text-center mb-8"><h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600 mb-2">Alpha Team ${TOTAL_QUESTS} Misi</h1><p class="text-gray-500">Siapkah kamu menyelesaikan ${TOTAL_QUESTS} tantangan AI?</p></div>
                <div class="bg-white rounded-2xl p-8 card-shadow animate-fade-in text-center max-w-md mx-auto">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6"><span class="text-4xl">üó∫Ô∏è</span></div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Identitas Petualang</h2>
                    <form id="name-form" class="space-y-4">
                        <input type="text" id="player-name-input" placeholder="Nama Panggilan" required maxlength="15" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-xl font-bold focus:border-indigo-500 focus:outline-none">
                        <button type="submit" id="start-btn" class="w-full ai-gradient text-white font-bold py-4 rounded-xl hover:opacity-90 transition transform hover:-translate-y-1">Mulai Petualangan</button>
                    </form>
                </div>`;
            document.getElementById('name-form').onsubmit = handleNameSubmit;
        }

        function renderActiveQuest(quest, solvedCount) {
            const currentLevel = solvedCount + 1;
            const progressPercent = (solvedCount / TOTAL_QUESTS) * 100;

            mainContainer.innerHTML = `
                 <div class="text-center mb-6 animate-fade-in">
                    <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">Alpha Team ${TOTAL_QUESTS} Misi</h1>
                    <div class="max-w-xl mx-auto mt-4 px-4">
                         <div class="flex justify-between text-sm font-semibold text-indigo-900 mb-1">
                            <span>${playerName}</span>
                            <span>Misi ${currentLevel} / ${TOTAL_QUESTS}</span>
                         </div>
                         <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                            <div class="ai-gradient h-2.5 rounded-full transition-all duration-700" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                </div>

                <div class="max-w-xl mx-auto relative px-4">
                    <div id="quest-card" class="bg-white rounded-3xl p-6 sm:p-10 card-shadow animate-fade-in relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-indigo-50 text-indigo-300 font-black text-8xl opacity-25 -mt-6 -mr-6 z-0">#${currentLevel}</div>
                        <div class="relative z-10">
                            <span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider mb-4">${quest.type === 'text' ? 'üß© Teka-Teki' : 'üì∏ Misi Foto'}</span>
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-8 leading-tight">"${quest.clue}"</h2>
                            
                            ${quest.type === 'text' 
                                ? `<form id="sub-form"><input type="text" id="ans-in" placeholder="Jawab di sini..." class="w-full p-4 text-lg border-2 border-gray-300 rounded-xl focus:border-indigo-600 focus:ring-0 mb-4" required> <button type="submit" id="sub-btn" class="w-full py-4 ai-gradient text-white font-bold rounded-xl hover:shadow-lg transition">Kirim Jawaban</button></form>`
                                : `<form id="sub-form"><label class="block w-full p-8 border-2 border-dashed border-indigo-300 rounded-xl text-center cursor-pointer hover:bg-indigo-50 transition mb-4"><div class="text-4xl mb-2">üì∑</div><span class="text-indigo-600 font-semibold">Ambil Foto Langsung</span><input type="file" id="photo-in" accept="image/*" capture="environment" class="hidden" required></label><div id="preview-container" class="hidden mb-4"><img id="photo-preview" class="h-40 mx-auto rounded-lg object-cover border-4 border-white shadow-md"></div><button type="submit" id="sub-btn" class="w-full py-4 ai-gradient text-white font-bold rounded-xl hover:shadow-lg transition">Kirim Bukti Foto</button></form>`
                            }
                            
                            <div class="mt-6 flex justify-center"><button id="hint-btn" class="text-sm text-indigo-500 hover:text-indigo-700 font-semibold flex items-center transition"><span class="mr-1">üí°</span> Butuh Petunjuk?</button></div>
                            <div id="hint-box" class="hidden mt-4 p-4 bg-amber-50 text-amber-800 rounded-xl border border-amber-100 text-sm animate-fade-in"></div>
                        </div>
                    </div>
                </div>`;

            document.getElementById('sub-form').onsubmit = (e) => handleSubmission(e, quest);
            document.getElementById('hint-btn').onclick = () => showHint(quest.hint);
            if (quest.type === 'photo') setupPhotoPreview();
        }

        function renderVictory() {
            // Hitung durasi
            let durationText = "";
            if (currentGameState.startedAt && currentGameState.completedAt) {
                const ms = currentGameState.completedAt.toDate() - currentGameState.startedAt.toDate();
                const minutes = Math.floor(ms / 60000);
                const seconds = ((ms % 60000) / 1000).toFixed(0);
                durationText = `${minutes} menit ${seconds} detik`;
            }

            mainContainer.innerHTML = `
                <div class="max-w-md mx-auto text-center animate-fade-in px-4">
                    <div class="inline-block p-6 bg-green-100 rounded-full mb-6"><span class="text-6xl">üèÜ</span></div>
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">MISI SELESAI!</h1>
                    <p class="text-xl text-indigo-900 font-semibold mb-6">${playerName}</p>
                    <div class="bg-white p-6 rounded-2xl card-shadow mb-8">
                        <p class="text-gray-500 mb-1">Total Waktu</p>
                        <p class="text-3xl font-bold text-indigo-600">${durationText || "Menghitung..."}</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl">
                        <h3 class="font-bold text-indigo-900 mb-4">üèÖ Papan Peringkat Tercepat (${TOTAL_QUESTS} Misi)</h3>
                        <div id="leaderboard-list" class="space-y-3 text-left max-h-60 overflow-y-auto text-sm px-1">Memuat...</div>
                    </div>
                </div>`;
            loadLeaderboard();
        }

        function setupPhotoPreview() {
            document.getElementById('photo-in').onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('photo-preview').src = e.target.result;
                        document.getElementById('preview-container').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        function showHint(hintText) {
            const box = document.getElementById('hint-box');
            box.textContent = hintText || "Tidak ada petunjuk. Semangat!";
            box.classList.remove('hidden');
        }
        function renderLoading(msg) {
            mainContainer.innerHTML = `<div class="flex flex-col items-center justify-center min-h-[50vh] animate-fade-in"><div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-6"></div><p class="text-lg text-indigo-800 font-medium animate-pulse-fast">${msg}</p></div>`;
        }

        // --- Event Handlers ---
        async function handleNameSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) return;
            playerName = name;
            // Menggunakan collection baru _10q
            await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/treasure_hunt_10q`, 'game_state'), {
                playerName, solvedCount: 0, startedAt: new Date(), currentQuest: null
            });
        }

        async function handleSubmission(e, quest) {
            e.preventDefault();
            const btn = document.getElementById('sub-btn');
            btn.disabled = true; 
            btn.innerHTML = quest.type === 'text' ? '‚ú® AI Menilai...' : 'üëÅÔ∏è AI Melihat...';
            let isCorrect = false;
            try {
                if (quest.type === 'text') {
                    const ans = document.getElementById('ans-in').value.trim();
                    isCorrect = ans.toLowerCase() === quest.correctAnswer.toLowerCase() || await validateWithAI(quest, ans);
                } else {
                    const file = document.getElementById('photo-in').files[0];
                    if (file) {
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(file);
                        });
                        isCorrect = await validateWithAI(quest, null, { mimeType: file.type, data: base64 });
                    }
                }

                if (isCorrect) {
                    showMessage(`üéâ ${quest.solvedMessage || 'Benar!'}`);
                    const newCount = (currentGameState.solvedCount || 0) + 1;
                    const updates = { solvedCount: newCount, currentQuest: null };
                    
                    if (newCount >= TOTAL_QUESTS) {
                        const endTime = new Date();
                        updates.completedAt = endTime;
                        const duration = endTime - currentGameState.startedAt.toDate();
                        // Simpan ke leaderboard publik saat selesai 10 misi (menggunakan _10q)
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/leaderboard_10q/${userId}`), {
                            name: playerName, duration: duration, completedAt: endTime
                        });
                    }
                    // Menggunakan collection baru _10q
                    await updateDoc(doc(db, `/artifacts/${appId}/users/${userId}/treasure_hunt_10q`, 'game_state'), updates);
                } else {
                    showMessage("‚ùå Kurang tepat, coba lagi!", true);
                    btn.disabled = false; btn.innerHTML = 'Coba Lagi';
                }
            } catch (err) {
                console.error(err);
                showMessage("‚ö†Ô∏è Gagal validasi AI. Coba lagi.", true);
                btn.disabled = false; btn.innerHTML = 'Kirim Ulang';
            }
        }

        async function loadLeaderboard() {
            // Mengambil dari leaderboard 10q
            const q = query(collection(db, `/artifacts/${appId}/public/data/leaderboard_10q`), orderBy('duration', 'asc'), limit(10));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach((doc, i) => {
                const data = doc.data();
                const minutes = Math.floor(data.duration / 60000);
                const seconds = ((data.duration % 60000) / 1000).toFixed(0);
                const isMe = doc.id === userId;
                
                // Format Tanggal
                let dateStr = '-';
                if (data.completedAt && data.completedAt.seconds) {
                    dateStr = new Date(data.completedAt.seconds * 1000).toLocaleDateString('id-ID', { 
                        day: 'numeric', month: 'short', year: 'numeric' 
                    });
                }

                html += `
                <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm ${isMe ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''}">
                    <div class="flex flex-col">
                        <span class="font-medium ${i < 3 ? 'text-amber-500' : 'text-gray-700'}">#${i+1} ${data.name}</span>
                        <span class="text-xs text-gray-400 flex items-center mt-0.5"><span class="mr-1">üìÖ</span>${dateStr}</span>
                    </div>
                    <span class="text-indigo-600 font-mono font-bold bg-indigo-100 px-2 py-1 rounded-md text-xs sm:text-sm">${minutes}m ${seconds}d</span>
                </div>`;
            });
            const listEl = document.getElementById('leaderboard-list');
            if (listEl) listEl.innerHTML = html || '<p class="text-center text-gray-400 py-2">Belum ada penakluk.</p>';
        }

        function showMessage(msg, isError = false) {
            messageBox.textContent = msg;
            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full font-bold shadow-lg text-white transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} translate-y-0 opacity-100`;
            setTimeout(() => { messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0 -translate-y-10'); }, 3000);
        }

        function renderError(msg) { mainContainer.innerHTML = `<div class="text-red-500 text-center p-4">${msg}</div>`; }
        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen flex flex-col">
    <div id="message-box" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 opacity-0 -translate-y-10 transition-all duration-300 pointer-events-none"></div>
    <main id="main-container" class="flex-grow p-4 flex flex-col justify-center"></main>
</body>
</html>